#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <stdint.h>
#include<string.h>
#include <time.h>

#define MAX_PEAKS 100
#define TAKE_FEATURES 10
#define NUM_FEATURES 20


// Function to compare two integers for qsor. i.e, a <= b
int compare(const void *a, const void *b) {
    return (*(int*)a - *(int*)b);
}


// AMPD algorithm to find peaks for the ppg signal
int ampd(double *ppg_filt, int n, int final_peaks[]) {
    int max_len = 0;
    int global_peaks[MAX_PEAKS]= {0};
    int global_peaks_len = 0;

    // Step 1: Find peaks using AMPD algorithm
    for (int window_len = 3; window_len < n - 3; window_len++) {
        int store[MAX_PEAKS];
        int store_len = 0;

        for (int low = 0; low + window_len < n; low++) {
            int max_index = low;
            double max_ppg_val = ppg_filt[low];

            for (int j = low; j < low + window_len; j++) {
                if (ppg_filt[j] > max_ppg_val) {
                    max_ppg_val = ppg_filt[j];
                    max_index = j;
                }
            }

            // Check if max_index is a valid peak and is not present in store
            if (max_index >= 1 && max_index + 1 < n && ppg_filt[max_index] > ppg_filt[max_index - 1] && ppg_filt[max_index] > ppg_filt[max_index + 1]) {
                
                int duplicate = 0;
                for (int k = 0; k < store_len; k++) {
                    if (store[k] == max_index) {
                        duplicate = 1;
                        break;
                    }
                }

                if (!duplicate) {
                    store[store_len] = max_index;
                    store_len++;
                }
            }
        }

        // Update global_peaks if more peaks are found
        if (store_len > max_len) {
            max_len = store_len;
            global_peaks_len = store_len;
            for (int i = 0; i < store_len; i++) {
                global_peaks[i] = 0;
                global_peaks[i] = store[i];
            }
        }
    }

    // Step 2: Improve peak detection and find foot peaks
    int improved_peaks[MAX_PEAKS] = {0};
    int improved_peaks_len = 0;

    for (int i = 0; i < global_peaks_len; i++) {
        int peak = global_peaks[i];
        while (peak + 1 < n && ppg_filt[peak] < ppg_filt[peak + 1]) {
            peak++;
        }
        improved_peaks[improved_peaks_len++] = peak;
    }

    // Step 3: Final peak selection based on distance between consecutive peaks
    int final_peaks_len = 0, tol = 10;
    final_peaks[final_peaks_len++] = improved_peaks[0];

    for (int i = 1; i < improved_peaks_len; i++) {
        if (improved_peaks[i] - final_peaks[final_peaks_len - 1] >= tol) {
            final_peaks[final_peaks_len++] = improved_peaks[i];
        }
    }

    return final_peaks_len;
}


void generate_random_indices(){
    int indices[TAKE_FEATURES];
    int is_chosen[NUM_FEATURES + 1] = {0}; 
    int i = 0;

    srand(time(NULL));

    while (i < TAKE_FEATURES) {
        int rand_index = rand() % (NUM_FEATURES);
        if (!is_chosen[rand_index]) {
            indices[i++] = rand_index;
            is_chosen[rand_index] = 1;
        }
    }

    qsort(indices, TAKE_FEATURES, sizeof(int), compare);

    printf("Random indices in sorted order: ");
    for (i = 0; i < TAKE_FEATURES; i++) {
        if (i == TAKE_FEATURES - 1)
        {
            printf("%d", indices[i]);
        }
        else
        {
            printf("%d,", indices[i]);
        }
    }
    printf("\n");

}
int main() {

    
    // double ppg_filt[] = {-0.36145489235674844,-1.2740359799926255,-1.2332703282484194,-0.16731947979364092,1.6007268888937738,3.5791434815274217,4.4544955598654585,2.6300780117995717,-1.527374089900123,-4.855389488849957,-4.071344629757759,0.3359194387847979,3.930703200730451,3.933646915488438,2.8052069513691107,3.4885615616366934,4.754598304913952,3.50493602005301,-0.8617642937762825,-5.555392846327978,-7.570921859673952,-6.786574772468139,-5.146005566557668,-3.8566662973630237,-2.5715062821299375,-0.7877245103481452,1.341448271128722,3.5634759719522315,5.722158179849057,7.074603997539372,6.047261601464918,1.7998627037298291,-3.840640692673901,-7.641483700545356,-8.330330605828967,-7.0888352044691905,-5.303640821570042,-3.517258823683908,-1.9066705356921763,-0.49155748151708123,1.1111856225860506,3.808004551466623,8.177415158411899,11.969968242569381,10.18271250020176,1.8524489572144875,-6.63151941479608,-9.551665296099804,-7.901419010659447,-5.286743089710228,-3.246269055361363,-1.557265293703838,0.12824973286545777,1.9019229584693793,3.858065255329908,6.167800612932173,8.414990624406334,8.83060508764014,5.512719225834062,-0.6645374400084832,-5.891843528113107,-7.391266088316467,-5.8403094412553385,-3.4325380137007757,-1.5887605398453815,-0.5426360318530655,0.3523424767131097,1.9176621959533864,4.3819470385973345,6.982813690829129,7.5876771304515795,3.942909880132111,-2.826398343389653,-7.796282851358164,-7.176204997858761,-2.5349464666494743,0.818894430813433,0.2501815491546924,-1.31348676117195,-0.6322528647550163,1.772435531325391,4.23218248442426,6.331459777197698,7.514301054113949,5.983253904242633,0.8792585430866463,-5.350812677957775,-9.047681625997841,-9.260978181688234,-7.597442716469006,-5.512624785992785,-3.419285417919001,-1.334636478773306,0.8369071840405632,3.4714320970981785,6.670955115581156,9.16051833336244,8.53806307038727,3.7433978438847846,-2.688447745515126,-6.664231973097158,-6.958799793054327,-5.5300809650144505,-4.258200079296868,-3.191090850495693,-0.9287623310929318,3.9882138689985975,10.296279934008489,12.823357409007198,7.887551836130988,-0.9758909675258276,-7.144546371867782,-8.441119173502484,-7.131584882794184,-5.416556088889035,-3.57122133006715,-0.9963711578781367,2.528528442574229,6.166744573742303,7.8801564643272615,5.743641365987548,0.5712453168929416,-3.8888549571571356,-4.86355105914873,-3.107079436573391,-0.7247157615642547,1.5123885856010149,3.889567884693761,6.1003327749602185,6.814444368607016,4.758613897769692,0.33356942725479066,-3.879004168941375,-5.271612344145551,-3.8177597764624505,-1.822962970275305,-1.2368606697662534,-1.1278985833001678,1.4804161963328637,6.77998139209012,9.569326500979589,5.201761450568475,-3.4003888277822507,-9.50236137829039,-10.674323755811011,-8.978002119877964,-6.361265929584368,-3.2128979635555317,0.3588825227327743};
    double ppg_filt[] = {-0.09996216937973501,1.1869257699464077,2.662946208939639,3.977961140974557,4.828625950398437,5.441144463137916,6.240337814539429,7.222377558114715,7.35907102578979,5.17445647104862,0.8700380714744942,-3.050541148499158,-4.3301000199193,-3.12538617497006,-1.1465214540587336,0.323173343089149,1.1507799725674799,1.7637707398521243,2.620828382032227,4.0205532238355275,5.365786644742671,4.848205426593446,1.331521931690777,-3.485662136140065,-6.42019443870646,-6.1956356804683335,-4.007407755898883,-1.4237718649804538,0.7916883954354283,2.4113907386148754,3.5872706927502893,4.765085986188006,5.762496560740734,5.07231933775798,1.4978835613449877,-3.4400650199313696,-6.598072155622039,-6.714001039474376,-5.08482967829021,-3.2616898683258353,-1.567335260241478,0.316119031009766,2.319791929969233,3.9949395000088344,4.9520293291114275,4.53694171195872,1.8795813601325424,-2.45081676836003,-5.921990362615233,-6.554318699697831,-4.913291627697637,-2.8776084253210303,-1.4226866166219614,-0.16889688505858833,1.5099898766436461,3.532332746243992,5.0598012290049414,4.986369493840753,2.720523639024111,-0.8799797707370132,-3.8111012181395565,-4.766183568628783,-3.9708533593843365,-2.230344950262574,-0.2171852185542141,1.48411702187878,2.6277331378957753,3.5719681352693025,4.694607444460132,5.457634286607265,4.347257255385457,0.6165450945772294,-3.8712328902129167,-6.196008537641599,-5.64357385230089,-3.709695845559414,-1.6652218238675025,0.24227597835576062,1.9923752793341665,3.547777384253342,4.959784041052442,5.7763540282557555,4.640640075208015,0.8157553516547779,-3.8199248540625494,-6.171548166880288,-5.413751237449802,-3.257379459224526,-1.2917881505175166,0.2633810533408315,1.8112208834317411,3.5337520748703026,5.126001212867862,5.886581042935319,4.797286025849018,1.2774422076319247,-3.305149244834771,-6.229319866427087,-6.296748658008029,-4.674339931157304,-2.934187453317806,-1.6016517321190773,-0.3686110575916498,1.2708753021244652,3.518888943280904,5.627210409518249,5.771954154437099,2.6511932006200354,-2.420067849978837,-6.276442393326643,-7.105547913975373,-5.577625082450701,-3.0990824525361598,-0.578672814209591,1.3715360248972133,2.557479113040839,3.612365220599351,5.153432602534164,6.2581883918499015,4.833736666654452,0.3440136178379827,-4.655295673977307,-7.036587836600599,-6.384525424530508,-4.336250584065053,-2.0156218139768165,0.21744754426742316,1.9824494822930168,3.2968635408657834,4.662781129544295,5.8141851147709085,5.166377482591972,1.6750777583838574,-2.9836560983433986,-5.672692168384524,-5.2231671553845525,-3.0121026396245236,-0.6112521408636369,1.5430781642199647,3.598533963578622,5.6556999356647495,7.685558678601807,9.30275455002406,9.297109554598496,6.379013483306726,1.3717163146774747,-2.6872566372396767,-3.61868086656785,-1.7910465841861982,1.2901819829826016};  // Replace with your data
    int n = sizeof(ppg_filt) / sizeof(ppg_filt[0]);

    int final_peaks[MAX_PEAKS] = {0};
    // int final_peaks_len = ampd(ppg_filt, n, final_peaks);

    // printf("peaks: [");
    // for (int i = 0; i < final_peaks_len; i++)
    // {
    //     if (i == final_peaks_len - 1)
    //     {
    //         printf("%d", final_peaks[i]);
    //     }
    //     else
    //     {
    //         printf("%d, ", final_peaks[i]);
    //     }
    // }
    // printf("]");
    // printf("\n");

    generate_random_indices();

    return 0;
}
