#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <stdint.h>
#include <string.h>

#define MAX_PEAKS 500

int ampd(double *ppg_filt, int n, int final_peaks[])
{
    int max_len = 0;
    int global_peaks[MAX_PEAKS] = {0};
    int global_peaks_len = 0;

    for (int window_len = 3; window_len < n - 3; window_len++)
    {
        int store[MAX_PEAKS];
        int store_len = 0;

        for (int low = 0; low + window_len < n; low++)
        {
            int max_index = low;
            double max_ppg_val = ppg_filt[low];

            for (int j = low; j < low + window_len; j++)
            {
                if (ppg_filt[j] >= max_ppg_val)
                {
                    max_ppg_val = ppg_filt[j];
                    max_index = j;
                }
            }

            if (max_index >= 1 && max_index + 1 < n && ppg_filt[max_index] >= ppg_filt[max_index - 1] && ppg_filt[max_index] >= ppg_filt[max_index + 1])
            {

                int duplicate = 0;
                for (int k = 0; k < store_len; k++)
                {
                    if (store[k] == max_index)
                    {
                        duplicate = 1;
                        break;
                    }
                }

                if (!duplicate)
                {
                    store[store_len] = max_index;
                    store_len++;
                }
            }
        }

        if (store_len > max_len)
        {
            max_len = store_len;
            global_peaks_len = store_len;
            for (int i = 0; i < store_len; i++)
            {
                global_peaks[i] = 0;
                global_peaks[i] = store[i];
            }
        }
    }

    int improved_peaks[MAX_PEAKS] = {0};
    int improved_peaks_len = 0, amplitude_tolerance = 10;

    for (int i = 0; i < global_peaks_len; i++)
    {
        int peak = global_peaks[i];
        while (peak + 1 < n && ppg_filt[peak] <= ppg_filt[peak + 1])
        {
            peak++;
        }
        if (ppg_filt[peak] >= amplitude_tolerance)
        {
            improved_peaks[improved_peaks_len++] = peak;
        }
    }

    int final_peaks_len = 0, tol = 5;
    final_peaks[final_peaks_len++] = improved_peaks[0];

    for (int i = 1; i < improved_peaks_len; i++)
    {
        if (improved_peaks[i] - final_peaks[final_peaks_len - 1] >= tol)
        {
            final_peaks[final_peaks_len++] = improved_peaks[i];
        }
    }
    return final_peaks_len;
}

void remove_baseline_ppg(double *input, double *output, int n)
{
    for (int i = 1; i < n; i++)
    {
        output[i - 1] = (input[i] - input[i - 1]);
    }
}


int main()
{

    double ppg_signal_1[] = {3388.94,3381.73,3376.37,3367.35,3364.67,3362.13,3356.95,3394.42,3406.22,3409.34,3403.55,3397.06,3392.49,3382.59,3378.41,3370.89,3364.55,3392.29,3411.41,3414.0,3411.47,3407.78,3399.33,3393.99,3383.45,3379.18,3370.83,3405.06,3424.98,3428.49,3426.91,3425.97,3424.25,3415.03,3408.85,3398.47,3392.39,3414.3,3442.3,3450.67,3453.91,3453.53,3452.66,3448.81,3441.85,3431.71,3423.16,3413.59,3457.12,3471.81,3477.06,3477.16,3477.68,3477.85,3472.28,3462.4,3453.87,3442.39,3430.2,3455.69,3480.14,3490.69,3491.46,3491.39,3491.89,3489.38,3479.85,3472.45,3460.46,3447.72,3440.15,3465.27,3491.23,3502.75,3503.93,3503.32,3503.37,3495.76,3489.47,3477.04,3465.67,3455.59,3442.96,3433.35,3426.02,3440.7,3481.65,3492.32,3496.67,3494.97,3493.51,3490.17,3478.93,3470.41,3457.62,3444.43,3434.97,3427.17,3466.42,3481.42,3489.54,3487.86,3483.86,3479.27,3473.71,3463.4,3451.7,3441.75,3430.05,3421.83,3421.87,3466.33,3474.35,3476.26,3474.63,3472.65,3467.2,3458.88,3445.35,3433.25,3425.2,3415.13,3408.98,3420.77,3457.95,3467.05,3471.26,3466.67,3464.18,3460.05,3452.26,3443.04,3429.51,3419.83,3411.82,3402.78,3398.96,3445.84,3457.78,3463.79,3460.55,3459.58,3456.57,3446.08,3435.19,3425.53,3413.02,3407.33,3397.26,3410.33,3445.29,3455.05,3454.99,3451.62,3447.83,3443.35,3432.15,3423.05,3411.92,3403.06,3396.27,3409.21,3445.9,3456.79,3457.7,3455.17,3452.58,3444.72,3433.75,3424.58,3412.89,3405.17,3397.41,3391.72,3421.57,3449.46,3459.82,3461.79,3459.39,3459.27,3453.6,3443.3,3430.01,3419.86,3411.65,3404.54,3398.18,3446.45,3460.09,3468.26,3465.63,3463.71,3461.47,3455.59,3443.85,3431.33,3423.02,3413.97,3408.45,3447.46,3464.81,3474.08,3473.51,3473.81,3470.45,3461.35,3448.38,3439.29,3427.97,3418.74,3412.06,3457.72,3474.38,3486.05,3487.05,3486.02,3483.07,3476.35,3467.41,3456.13,3442.97,3431.18,3428.03,3475.47,3489.37,3495.7,3493.27,3493.15,3490.89,3484.89,3473.66,3459.66,3447.21,3439.14,3462.97,3489.98,3499.41,3501.96,3499.74,3497.01,3489.11,3475.62,3461.53,3450.38,3441.65,3451.39,3490.55,3502.53,3506.5,3505.42,3504.97,3500.85,3491.94,3477.66,3464.01,3454.9,3444.26,3451.68,3497.08,3509.58,3518.42,3516.87,3515.95,3512.19,3506.29,3493.08,3479.05,3468.14,3456.99,3445.56,3482.58,3505.03,3516.87,3517.18,3515.62,3513.91,3507.58,3499.59,3487.99};
    double ppg_signal_2[] = {2945.79,2933.32,2919.87,2911.24,2905.43,2902.18,2915.61,3000.05,3003.3,2994.13,2965.22,2949.26,2933.86,2920.97,2916.81,2911.24,2908.14,2991.46,3006.42,2999.7,2972.7,2961.93,2949.36,2934.66,2926.23,2918.09,2917.82,3010.33,3026.49,3025.07,3005.37,2999.23,2984.18,2964.43,2945.85,2934.33,2928.09,3014.67,3043.19,3050.34,3040.74,3032.04,3026.37,3009.55,2983.74,2967.63,2952.89,2969.73,3057.66,3068.19,3071.26,3060.73,3060.28,3054.46,3029.27,3006.47,2986.96,2972.77,2964.06,3053.29,3078.08,3085.23,3076.36,3075.01,3071.92,3058.03,3035.99,3014.07,2998.07,2981.79,2972.34,3064.25,3089.92,3097.37,3090.03,3086.59,3081.35,3063.18,3042.24,3017.49,3001.83,2988.71,2976.32,2967.65,2960.23,3042.94,3085.28,3091.97,3090.87,3082.91,3073.81,3055.67,3029.61,3010.84,2991.87,2979.27,2967.27,2971.37,3067.5,3079.69,3083.06,3069.63,3063.54,3054.14,3029.81,3009.96,2991.52,2978.78,2968.44,2960.38,3014.49,3069.4,3074.15,3065.41,3054.52,3051.05,3031.66,3009.84,2986.99,2974.99,2964.66,2956.21,2949.36,3027.47,3063.89,3071.09,3065.16,3053.23,3046.9,3030.11,3005.41,2986.75,2973.21,2961.19,2953.35,2946.69,2981.18,3055.68,3060.74,3063.01,3045.49,3043.18,3027.07,3000.23,2977.98,2964.8,2952.43,2944.6,2937.1,3012.01,3049.29,3052.03,3036.22,3025.59,3018.15,2997.75,2979.78,2964.63,2952.99,2945.52,2938.47,3013.11,3049.26,3056.3,3043.98,3032.42,3023.9,2999.03,2975.79,2961.53,2950.78,2941.95,2935.9,2932.91,3027.32,3050.55,3058.31,3047.26,3039.21,3031.11,3009.19,2986.99,2971.21,2959.02,2950.0,2944.05,2971.8,3050.94,3059.33,3061.96,3045.87,3043.33,3029.63,3006.85,2987.86,2974.97,2961.73,2953.61,2959.27,3052.09,3062.79,3068.29,3054.58,3052.37,3039.44,3015.45,2993.61,2977.63,2966.95,2957.94,2964.99,3060.94,3072.58,3079.36,3069.93,3066.55,3057.7,3036.33,3014.1,2998.11,2982.57,2971.74,3014.92,3080.85,3090.17,3091.88,3078.18,3075.73,3062.29,3042.22,3019.92,3006.46,2992.27,2982.62,3067.37,3090.85,3097.01,3088.28,3082.47,3073.53,3045.56,3023.83,3005.53,2992.47,2982.29,3053.7,3091.75,3101.32,3096.96,3087.09,3082.49,3066.34,3046.45,3025.26,3009.78,2996.27,2985.75,3053.81,3102.42,3111.59,3112.13,3102.65,3100.58,3090.44,3070.36,3047.32,3030.1,3015.45,3003.05,3003.1,3090.49,3108.38,3117.41,3106.37,3104.05,3094.61,3076.45,3058.75,3044.07};


    int n = sizeof(ppg_signal_1) / sizeof(ppg_signal_1[0]);
    int print_signal = 0;
    double diff_ppg_signal_1[n - 1];
    remove_baseline_ppg(ppg_signal_1, diff_ppg_signal_1, n);

    if (print_signal)
    {
        printf("printing first signal\n");
        for (int i = 0; i < n - 1; i++)
        {
            printf("%f,", diff_ppg_signal_1[i]);
        }
        printf("\n");
        printf("\n");
        printf("\n");
    }
    double diff_ppg_signal_2[n - 1];
    remove_baseline_ppg(ppg_signal_2, diff_ppg_signal_2, n);

    if (print_signal)
    {
        printf("printing second signal\n");
        for (int i = 0; i < n - 1; i++)
        {
            printf("%f,", diff_ppg_signal_2[i]);
        }
        printf("\n");
        printf("\n");
        printf("\n");
    }
    int print_peaks = 0;

    int final_peaks1[MAX_PEAKS] = {-1};
    int final_peaks_len = ampd(diff_ppg_signal_1, n-1, final_peaks1);
    if (print_peaks)
    {
        printf("printing peaks of first signal: \n");
        for (int i = 0; i < final_peaks_len; i++)
        {
            printf("%d,", final_peaks1[i]);
        }
        printf("\n");
        printf("\n");
        printf("\n");

    }

    int final_peaks2[MAX_PEAKS] = {-1};
    int final_peaks_len2 = ampd(diff_ppg_signal_2, n-1, final_peaks2);
    if (print_peaks)
    {
        printf("printing peaks from second signal: \n");
        for (int i = 0; i < final_peaks_len2; i++)
        {
            printf("%d,", final_peaks2[i]);
        }
        printf("\n");
        printf("\n");
        printf("\n");
    }

    int min_length = (final_peaks_len < final_peaks_len2) ? final_peaks_len : final_peaks_len2;

    double Average_ptt = 0.0, fs = 26.0;
    int divider = 0;
    for (int i = 0; i < min_length; i++)
    {
        int peak1 = final_peaks1[i], peak2 = final_peaks2[i];
        if (peak1 == -1 || peak2 == -1)
        {   
            printf("Couldn't find peaks, returning\n");
            break;
        }
        int peak_diff = (peak1 > peak2) ? (peak1 - peak2) : (peak2 - peak1);
        
        if (peak_diff >= 1)
        {
            Average_ptt += ((double)peak_diff / fs);
            divider++;
        }
    }

    // if (divider)
    // {
    //     Average_ptt /= divider;
    // }

    printf("Average Pulse transmit time is: %.4f seconds\n", Average_ptt);

    return 0;
}
